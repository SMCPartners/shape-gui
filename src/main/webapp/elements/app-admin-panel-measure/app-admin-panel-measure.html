<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../elements.html">

<dom-module id="app-admin-panel-measure">
    <style>
        .pms {
        @apply(--pm-style)
        };

        th {
        text-align: center;
        background-color: #0066FF;
        color: white;
        border-right: 1px solid #808080;
        border-bottom: 1px solid #808080;
        font-weight: bold;
        };

        th, td {
          padding: 10px 15px;
          -webkit-user-select: none;   /*these make it so that text is not selectable*/
          -khtml-user-select: none;
          -moz-user-select: none;
          user-select: none;
          font-family: Roboto;
        };

        .editButton {
          background-color: #E6E6FA;
          margin: 2%;
          width: 80%;
          height: 90%;
        };

        thead {
        background: #395870;
        color: #fff;
        };

        td {
        border-bottom: 1px solid #cecfd5;
        border-right: 1px solid #cecfd5;
        border-left: 1px solid #cecfd5;
        };

        td: first-child {
        border-left: 1px solid #cecfd5;
        };

        tr: nth-child(even) {
        background-color: #395870;
        };

        table {
            border-collapse: separate;
            border-spacing: 0;
        };
        a {
          text-decoration: none;
          color: white;
          font-weight: bold;
        }

        .flex-item {
        order: 0;
        flex: 1 1 auto;
        align-self: auto;
        };

    </style>
    <template>
      <shape-iron-ajax-helper
          id="findMeasures"
          resource="/common/measure/findAll"
          handle-as="json"
          on-response="callBack"
          debounce-duration="300">
      </shape-iron-ajax-helper>
        <div style="padding: 0 0.4em; display: flex;" class='flex-container'>
            <div class="flex-item"><input class="search" type="text" value="{{filterVal::input}}" data-table="order-table" placeholder="Search" style="height: 2em; margin: 0.5em 0.4em;"></div>
            <div class="flex-item">
                <paper-button raised on-tap="addMeasure" modalName="addMeasure" style="float:right; padding-top: 0.1em;">Add Measure</paper-button>
            </div>
        </div>
        <table class="order-table table-rows" style="width: 100%; padding: 0 0.4em;">
            <colgroup>
                <col span="2" style="width:10%">
                <col span="1" style="width:20%">
                <col span="1" style="width:60%">
                <col span="1" style="width:10%">
            </colgroup>
            <thead>
                <th>Selection</th>
                <th><a sortingGroup='nqfId' on-tap="selectFunction">NQF ID</a></th>
                <th><a sortingGroup='name' on-tap="selectFunction">Name</a></th>
                <th><a sortingGroup='description' on-tap="selectFunction">Description</a></th>
                <th></th>
            </thead>
            <tbody>
            <template is="dom-repeat" items="{{measure}}" filter="{{_filter(filterVal)}}" sort="{{_sort(sortVal)}}">
            <tr data-id$="{{item.id}}">
                <td>
                  <div align="center">
                    <template restamp="true" is="dom-if" if="{{item.selected}}">
                      <form on-tap="unselectMeasure">
                        <input checked id=unselectUserMeasure type="checkbox" name="measureUnselect" value="{{item.id}}">
                      </form>
                    </template>
                  </div>
                  <div align="center">
                    <template restamp="true" is="dom-if" if="{{!item.selected}}">
                      <form on-tap="selectMeasure">
                        <input id=selectUserMeasure type="checkbox" name="measureSelect" value="{{item.id}}">
                      </form>
                    </template>
                  </div>
                </td>
                <td><span>{{item.nqfId}}</span></td>
                <td><span>{{item.name}}</span></td>
                <td><span>{{item.description}}</span></td>
                <div align="center">
                  <td style="font-size: 1em;">
                        <paper-button class="editButton" raised on-tap="editMeasure" modalName="editMeasure" id="{{item.index}}"><b>Edit</b></paper-button>
                  </td>
                </div>
            </tr>
            </template>
                <app-admin-add id="inputModal"></app-admin-add>
                <app-admin-edit id="editModal"></app-admin-edit>
            </tbody>
        </table>
        <shape-iron-ajax-helper
            id="ajaxSelectMeasure"
            resource="/admin/measure/select"
            handle-as="json"
            method="POST"
            on-response="selectMeasureCallBack"
            debounce-duration="300">
        </shape-iron-ajax-helper>
        <shape-iron-ajax-helper
            id="ajaxUnselectMeasure"
            resource="/admin/measure/unselect"
            handle-as="json"
            method="POST"
            on-response="unselectMeasureCallBack"
            debounce-duration="300">
        </shape-iron-ajax-helper>
    </template>
</dom-module>
<script>
    (function() {
    Polymer({
            is: 'app-admin-panel-measure',
            properties: {
                nqfId: String,
                measureName: String,
                measureDescription: String,
                sortVal: "defaultsort",
                lastSortVal: "nqfID",
                sortPass: String,
                sortReverse: false

            },

            ready: function() {
            },

            _filter: function(val) {
                return function(measure) {
                    if (!val) return true;
                    if (!measure) return false;
                    return (measure.nqfId && ~measure.nqfId.toLowerCase().indexOf(val.toLowerCase())) ||
                            //(measure.cmsID && ~measure.cmsID.toLowerCase().indexOf(val.toLowerCase())) ||
                            (measure.name && ~measure.name.toLowerCase().indexOf(val.toLowerCase())) ||
                            (measure.description && ~measure.description.toLowerCase().indexOf(val.toLowerCase()));
               };
            },


              selectFunction: function(e) {
              val = e.target.getAttribute('sortinggroup');  //this allows the function to retreive the 'sortingGroup' attribute from the clicked button.
              this.sortPass = val;
              console.log("target click: " + val);
              console.log("lastSortVal is " + this.lastSortVal);

              if (val === this.lastSortVal) {    //sortJim is a toggle that makes sure that rows do not stay in reverse
                  this.sortReverse = true;
                  this.sortVal = val.toUpperCase();
                  this.lastSortVal = val.toUpperCase;
                  }
              else
                {
                  this.sortReverse = false;
                  this.sortVal = val;
                  this.lastSortVal = val;

                };



              },

            _sort: function(val) {
                  var clicked = this.sortPass;
                  console.log("sortReverse is " + this.sortReverse)
                  if (this.sortReverse) {
                            return function(a, b) {
                            if (a[clicked].toLowerCase() === b[clicked].toLowerCase()) return 0;
                            return a[clicked].toLowerCase() < b[clicked].toLowerCase() ? 1 : -1;
                          }
                      }

                      else {
                            return function(a, b) {
                            if (a[clicked].toLowerCase() === b[clicked].toLowerCase()) return 0;
                            return a[clicked].toLowerCase() < b[clicked].toLowerCase() ? -1 : 1;
                      };
                    }
             },

            editMeasure: function(e) {
                this.$.editModal.editButton(e.target.parentNode.getAttribute("modalName"));
                console.log(e.target.parentNode);
                var measureNum = e.target.parentNode.getAttribute('id');
                console.log(measureNum);
                this.$.editModal.measure = Object.create(this.measure[measureNum]);
                console.log(this.measure[measureNum - 1]);
            },

            editMeasure: function(e) {
              var measureId = this.findAncestor(e.target, 'tr').dataset.id;
              for (var measures in this.measure) {
                if (this.measure[measures].id == measureId) {
                  var measureData = this.measure[measures];
                }
              }
              this.$.editModal.editMeasureButton(measureData);
            },

            selectMeasure: function (e) {
                console.log(e.currentTarget.selectUserMeasure.value);
                this.$.ajaxSelectMeasure.body = JSON.stringify({
                  "entId" : e.currentTarget.selectUserMeasure.value,
                });
                this.$.ajaxSelectMeasure.generateRequest();
            },

            selectMeasureCallBack: function(request) {
                document.querySelector('app-history').setajaxMeasures();
                this.setajax();
                console.log(request);
            },

            unselectMeasure: function (e) {
                console.log(e.currentTarget.unselectUserMeasure.value);
                this.$.ajaxUnselectMeasure.body = JSON.stringify({
                  "entId" : e.currentTarget.unselectUserMeasure.value,
                });
                this.$.ajaxUnselectMeasure.generateRequest();
            },

            unselectMeasureCallBack: function(request) {
                document.querySelector('app-history').setajaxMeasures();
                this.setajax();
                console.log(request);
            },

            addMeasure: function(e) {
                this.$.inputModal.addButton(e.target.parentNode.getAttribute("modalName"));
            },

            findAncestor: function(element, query) {
              do {
                element = element.parentElement;
              } while (element && !this.elementMatches(element, query))
              return element;
            },
            elementMatches: function(element, query) {
              var siblingMatches = element.parentElement.querySelectorAll(query)
              for (var match = 0; match < siblingMatches.length; match++) {
                if (siblingMatches[match] == element) return true;
              }
              return false;
            },

            setajax: function() {
              this.$.findMeasures.callBack = this.callBack;
              this.$.findMeasures.generateRequest();
            },

            callBack: function(request) {
              console.log(request.detail.response);
              this.organization = request.detail.response;
              for (i = 0; i < this.organization.length; i ++){
                this.organization[i].index = i;
                console.log(this.organization[i].index);
              };
            },

           callBack: function(request) {
             console.log(request.detail.response);
             this.measure = request.detail.response;
             for (i = 0; i < this.measure.length; i ++){
               this.measure[i].index = i;
               console.log(this.measure[i].index);
             };
           }
        });
})();
</script>
