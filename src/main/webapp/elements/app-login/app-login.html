<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../elements.html">

<dom-module id="app-login">
    <style>

        paper-material {
          max-width: 400px;

        }
        h1 {
          left: 15px;
          font-size: 15px;
          padding-left: 10px;
          padding-top: 10px;
        }
        paper-input {
          margin: auto;
          width: 50%;
          padding: 10px;
        }
        #login {
          margin-left: auto;
          margin-right: 10px;
          padding-left: 50px;
        }
        #forgotPasswordButton {
          margin-left: 10px;
          margin-right: auto;

        }
        paper-material {
          margin-left: auto;
          margin-right: auto;

        }
        paper-button {
          padding: 20px;
          margin-left: auto;
          margin-right: auto;
          display: inline-block;
        }
    </style>
    <template>
      <paper-material elevation="2">
        <h1>SHAPE Login</h1>
          <paper-input id="userIdInput" label="User ID"></paper-input>
            <br/>
          <paper-input label="Password" id="passwordInput" type="password" on-keydown="checkKeyStroke"></paper-input>
            <paper-button id="login" on-tap="logIn" raised noink>Login</paper-button>
            <paper-button id="forgotPasswordButton" on-tap="resetPassword" raised noink>Forgot Password?</paper-button>
            <paper-button on-tap="showUserGuide">View SHAPE User Guide</paper-button>
      </paper-material>
      <div>
      </div>
          <shape-iron-ajax-helper id="loginCall">
          </shape-iron-ajax-helper>
          <shape-iron-ajax-helper id="secureCall">
          </shape-iron-ajax-helper>
          <shape-iron-ajax-helper
              id="findUsers"
              resource=""
              handle-as="json"
              on-response="callBackfindUsers"
              debounce-duration="300">
          </shape-iron-ajax-helper>
    </template>
</dom-module>
<script>
    (function () {
        Polymer({
            is: 'app-login',

            properties: {
                route: {
                  type: String
                },

                userId: {
                    type: String,
                    notify: true
                },
                password: {
                    type: String
                },
                role : {
                    type: String
                },
                organziationId : {
                    type: String
                },
                organizationName : {
                    type: String
                }
            },
            loginResponse: function(response){
              app.$.loginPage.$.passwordInput.value="";
              app.$.loginPage.$.findUsers.resource="/admin/user/find/" + app.$.loginPage.$.userIdInput.value;
              app.$.loginPage.$.findUsers.callBack=this.callBackfindUsers;
              app.$.loginPage.$.findUsers.generateRequest();
            },

            logIn: function () {
              this.$.loginCall.callBack = this.loginResponse;
              this.$.loginCall.login(this.$.userIdInput.value, this.$.passwordInput.value);
            },
            logout: function(){
              localStorage.token = "";
              app.select = "login"
            },

            callBackfindUsers: function(request) {
              callBackUser=request.detail.response;
              document.querySelector('app-admin-panel').set("role", callBackUser.role);
              document.querySelector('app-admin-panel-user').set("organizationId", callBackUser.organizationId);
              document.querySelector('app-admin-panel-user').set("role", callBackUser.role);
              document.querySelector('app-admin-panel-organization').set("role", callBackUser.role);
              document.querySelector('app-main').set("role", callBackUser.role);
              document.querySelector('app-admin-add').set("role", callBackUser.role);
              document.querySelector('app-admin-edit').set("role", callBackUser.role);
              document.querySelector('app-measure-input').set("role", callBackUser.role);
              document.querySelector('app-dashboard').set("organizationId", callBackUser.organizationId);
              document.querySelector('app-dashboard').set("role", callBackUser.role);
              if  (callBackUser.resetPwd == true) {
                app.select = "setupAccount";
                }   else {
                app.select = "main";
                //this.$.loginCall.login(this.$.userIdInput.value, this.$.passwordInput.value);
                //document.querySelector('app-account-setup').ajaxFindUsers();
                document.querySelector('app-dashboard').setAjax();
                document.querySelector('app-history').setajaxMeasures();
              };
            },

            navigateHome: function (e) {
                this.selected = 'main';
            },
            resetPassword: function(){
              app.select = "resetPassword"
            },
            checkKeyStroke: function(e){
              if (e.keyCode === 13){
                app.$.loginPage.logIn()
              }
            },
            showUserGuide: function(e){
              window.open("images/SHAPE_Dashboard_User_Guide.pdf", '_blank')
            }
        });
    })();
</script>
