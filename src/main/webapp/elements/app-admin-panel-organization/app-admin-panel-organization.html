<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../elements.html">

<dom-module id="app-admin-panel-organization">
    <style>
        .pms {
        @apply(--pm-style)
        };

        th {
        text-align: center;
        background-color: #0066FF;
        color: white;
        border-right: 1px solid #808080;
        border-bottom: 1px solid #808080;
        font-weight: bold;
        };

        th, td {
          padding: 5px 7.5px;

          -webkit-user-select: none;   /*these make it so that text is not selectable*/
          -khtml-user-select: none;
          -moz-user-select: none;
          user-select: none;
          font-family: Roboto;

        };

        thead {
        background: #395870;
        color: #fff;
        };

        td {
        border-bottom: 1px solid #cecfd5;
        border-right: 1px solid #cecfd5;
        border-left: 1px solid #cecfd5;
        };

        .editButton {
          background-color: #E6E6FA;
          margin: 2%;
          width: 80%;
        };

        table {
        border-collapse: separate;
        border-spacing: 0;
        };

        .green {
          background-color: green;
          color: white;
          align-self: center;
          width: 80%;
          height: 90%;
        };

        .red {
          background-color: red;
          color: white;
          align-self: center;
          width: 80%;
          margin: 2%;
        };

        .flex-item {
        order: 0;
        flex: 1 1 auto;
        align-self: auto;
        }

        .noWrap {
          white-space: nowrap;
        }

    </style>
    <template>

      <shape-iron-ajax-helper
          id="findOrganizations"
          resource="/admin/organization/findAll"
          handle-as="json"
          on-response="callBack"
          debounce-duration="300">
      </shape-iron-ajax-helper>
        <div style="padding: 0 0.4em; display: flex;" class='flex-container'>
            <div class="flex-item"><input type="text" value="{{filterVal::input}}" data-table="order-table" placeholder="Search" style="height: 2em; margin: 0.5em 0.4em;"></div>
            <template is="dom-if" if="{{isOrgAdmin(role)}}">
            <div class="flex-item">
                <paper-button raised on-tap="addOrganization" modalName="addOrganization" style="float:right;padding-top: 0.1em;">Add Organization</paper-button>
            </div>
            </template>
        </div>
        <table class="order-table table-rows" style="width: 100%; padding: 0 0.4em;">
            <colgroup>
                <col span="1" style="width:20%">
                <col span="1" style="width:10%">
                <col span="3" style="width:15%">
                <col span="3" style="width:8.33%">
            </colgroup>
            <thead>
                <th sortingGroup="name" on-tap="selectFunction">Name</th>
                <th sortingGroup="addressState" on-tap="selectFunction">Address</th>
                <th sortingGroup="primaryContactPhone" on-tap="selectFunction">Primary Contact Phone</th>
                <th sortingGroup="primaryContactName" on-tap="selectFunction">Primary Contact Name</th>
                <th sortingGroup="primaryContactEmail" on-tap="selectFunction">Primary Contact Email</th>
                <th sortingGroup= "primaryContactRole" on-tap="selectFunction">Primary Contact Role</th>
                <th hidden="{{!isOrgAdmin(role)}}" sortingGroup= "organizationStatus" on-tap="selectFunction">Status</th>
                <th hidden="{{!canEdit(role)}}"></th>
            </thead>
            <tbody>
            <template id="orgTable" is="dom-repeat" items="{{organization}}" filter="{{_filter(filterVal)}}" sort="{{_sort(sortVal)}}">
                <tr data-id$="{{item.id}}">
                    <td><span>{{item.name}}</span></td>
                    <td><span class="nowrap">{{item.addressStreet}}</span><br><span>{{item.addressCity}}</span>&nbsp<span>{{item.addressState}}</span>&nbsp<span>{{item.addressZip}}</span></td>
                    <td><span class="noWrap">{{item.primaryContactPhone}}</span></td>
                    <td><span class="noWrap">{{item.primaryContactName}}</span></td>
                    <td><span>{{item.primaryContactEmail}}</span></td>
                    <td><span>{{item.primaryContactRole}}</span></td>
                    <td hidden="{{!isOrgAdmin(role)}}">
                      <div align="center">
                      <template restamp="true" is="dom-if" if="{{item.active}}">
                        <paper-button align="center" class="green" organizations={{item}} on-tap="setAjaxInactivate"><b>Active</b></paper-button>
                      </template>
                    </div>
                      <div align="center">
                      <template restamp="true" is="dom-if" if="{{!item.active}}">
                        <paper-button align="center" class="red" organizations={{item}} on-tap="setAjaxActivate"><b>Inactive<b></paper-button>
                      </template>
                    </div>
                    </td>
                    <div align="center">
                      <td hidden="{{!canEdit(role)}}" style="font-size: 1em;">
                            <paper-button class="editButton" raised on-tap="editOrganization" modalName="editOrganization"><b>Edit</b></paper-button>
                      </td>
                    </div>
                </tr>
            </template>
                <app-admin-add id="inputModal"></app-admin-add>
                <app-admin-edit id="editModal"></app-admin-edit>
            </tbody>
        </table>
        <shape-iron-ajax-helper
            id="ajaxActivateOrg"
            resource=""
            body=""
            method=""
            handle-as="json"
            on-response="callBackActivate"
            debounce-duration="300">
        </shape-iron-ajax-helper>
        <shape-iron-ajax-helper
            id="ajaxInactivateOrg"
            resource=""
            body=""
            method=""
            handle-as="json"
            on-response="callBackInactivate"
            debounce-duration="300">
        </shape-iron-ajax-helper>
    </template>
</dom-module>
<script>
    (function() {
    Polymer({
            is: 'app-admin-panel-organization',
            properties: {
            name: String,
            address: String,
            list: Object
            },

            ready: function() {
            },

            _filter: function(val) {
                return function(organization) {
                    if (!val) return true;
                    if (!organization) return false;
                    return (organization.name && ~organization.name.toLowerCase().indexOf(val.toLowerCase())) ||
                            (organization.address && ~organization.address.toLowerCase().indexOf(val.toLowerCase()));
               };
            },

            isOrgAdmin : function (role) {
              if (role == "ADMIN") {
                return true
            } else {
                return false;
            }

            },

            isDPHUser : function (role) {
              if (role == "DPH_USER") {
                  return false
              } else {
                  return true
              }
            },

            canEdit : function (role) {
                if (role == "ORG_ADMIN" || role == "ADMIN") {
                    return true;
                } else {
                    return false;
                }
            },

            setAjaxActivate: function(e) {
              this.$.ajaxActivateOrg.resource="/admin/organization/activate/";
              this.$.ajaxActivateOrg.body = JSON.stringify ({"entId": e.currentTarget.organizations.id});
              this.$.ajaxActivateOrg.method="POST";
              this.$.ajaxActivateOrg.callBack=this.callBackActivate
              this.$.ajaxActivateOrg.generateRequest();
              activeIndicator=e.currentTarget;
            },

            setAjaxInactivate: function(e) {
              this.$.ajaxInactivateOrg.resource="/admin/organization/inactivate/";
              this.$.ajaxInactivateOrg.body = JSON.stringify ({"entId": e.currentTarget.organizations.id});
              this.$.ajaxInactivateOrg.method="POST";
              this.$.ajaxInactivateOrg.callBack=this.callBackInactivate
              this.$.ajaxInactivateOrg.generateRequest();
              activeIndicator=e.currentTarget;
            },

            callBackActivate: function(request) {
                for(var i = 0; i<this.organization.length; i++){
                  if (this.organization[i].id == activeIndicator.organizations.id){
                    stringPath= 'organization.'+i+'.active';
                    this.set(stringPath, true);
                  };
                };
            },

            callBackInactivate: function(request) {
               for(var i = 0; i<this.organization.length; i++){
                 if (this.organization[i].id == activeIndicator.organizations.id){
                   stringPath= 'organization.'+i+'.active';
                   this.set(stringPath, false);
                 };
               };
             },

            selectFunction: function(e) {
              val = e.target.getAttribute('sortinggroup');  //this allows the function to retreive the 'sortingGroup' attribute from the clicked button.
              this.sortPass = val;

              if (val === this.lastSortVal) {    //sortJim is a toggle that makes sure that rows do not stay in reverse
                  this.sortReverse = true;
                  this.sortVal = val.toUpperCase();
                  this.lastSortVal = val.toUpperCase;
                  }
              else
                {
                  this.sortReverse = false;
                  this.sortVal = val;
                  this.lastSortVal = val;

                };



              },

            _sort: function(val) {
                  var clicked = this.sortPass;
                  if (this.sortReverse) {
                            return function(a, b) {
                            if (a[clicked].toLowerCase() === b[clicked].toLowerCase()) return 0;
                            return a[clicked].toLowerCase() < b[clicked].toLowerCase() ? 1 : -1;
                          }
                      }

                      else {
                            return function(a, b) {
                            if (a[clicked].toLowerCase() === b[clicked].toLowerCase()) return 0;
                            return a[clicked].toLowerCase() < b[clicked].toLowerCase() ? -1 : 1;
                      };
                    }
             },

            editOrganization: function(e) {
              var organizationId = this.findAncestor(e.target, 'tr').dataset.id;
              for (var organizations in this.organization) {
                if (this.organization[organizations].id == organizationId) {
                  var organizationData = this.organization[organizations];
                }
              }
              this.$.editModal.editOrganizationButton(organizationData);
            },

            addOrganization: function(e) {
                this.$.inputModal.addButton(e.target.parentNode.getAttribute("modalName"));
            },

            findAncestor: function(element, query) {
              do {
                element = element.parentElement;
              } while (element && !this.elementMatches(element, query))
              return element;
            },
            elementMatches: function(element, query) {
              var siblingMatches = element.parentElement.querySelectorAll(query)
              for (var match = 0; match < siblingMatches.length; match++) {
                if (siblingMatches[match] == element) return true;
              }
              return false;
            },

            setajax: function() {
              this.$.findOrganizations.callBack = this.callBack
              this.$.findOrganizations.generateRequest();
            },

           callBack: function(request) {
             this.organization = request.detail.response;
             for (i = 0; i < this.organization.length; i ++){
               this.organization[i].index = i;
             };
           },
           storeValue: function() {

           }
        });
})();
</script>
