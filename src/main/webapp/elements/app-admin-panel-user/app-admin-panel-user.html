  <link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../elements.html">


<dom-module id="app-admin-panel-user">
    <style>
        .pms {
        @apply(--pm-style);
        };

        th {
          text-align: center;
          background-color: #0066FF;
          color: white;
          border-right: 1px solid #808080;
          border-bottom: 1px solid #808080;
          font-weight: bold;
        };

        th, td {
          padding: 10px 15px;
        };

        thead {
          background: #395870;
          color: #fff;
        };

        td {
          border-bottom: 1px solid #cecfd5;
          border-right: 1px solid #cecfd5;
          border-left: 1px solid #cecfd5;
        };

        td: first-child {
          border-left: 1px solid #cecfd5;
        };

        tr: nth-child(even) {
          background-color: #395870;
        };

        table {
          border-collapse: separate;
          border-spacing: 0;
        };
        option {
          font-size:1em;
        };

        .flex-item {
          order: 0;
          flex: 1 1 auto;
          align-self: auto;
        };

        .green {
          background-color: green;
          color: white;
          align-self: center;
          width: 80%;
          height: 90%;
        };

        .editButton {
          background-color: #E6E6FA;
          margin: 2%;
          width: 80%;
        };

        .red {
          background-color: red;
          color: white;
          align-self: center;
          width: 80%;
          height: 90%;
        };

    </style>
    <template>
        <div style="padding: 0 0.4em; display: flex;" class='flex-container'>
            <div class="flex-item"><input type="text" value="{{filterVal::input}}" data-table="order-table" placeholder="Search" style="height: 2em; margin: 0.5em 0.4em;"></div>
            <template is="dom-if" if="{{isOrgAdmin(role)}}">
              <div class="flex-item">
                <paper-button raised on-tap="addUser" modalName="addUser" style="float:right; padding-top: 0.1em;">Add User</paper-button>
              </div>
            </template>
        </div>
        <iecompat-table id="table" table-top='["Username", "Name", "Role", "Organization", "Status", ""]' >
                <th sortingGroup='id' on-tap="selectFunction">Username</th>
                <th sortingGroup='firstName' on-tap="selectFunction">Name</th>
                <th sortingGroup='role' on-tap="selectFunction">Role</th>
                <th sortingGroup='organizationName' on-tap="selectFunction">Organization</th>
                <th hidden="{{!isOrgAdmin(role)}}" sortingGroup='userStatus' on-tap="selectFunction">Status</th>
                <th hidden="{{!isOrgAdmin(role)}}"></th>
            <tbody>
            <template is="dom-repeat" id="table" items="{{users}}" filter="{{_filter(filterVal)}}" sort="{{_sort(sortVal)}}">
                <tr data-id$="{{item.id}}">
                    <td><span>{{item.id}}</span></td>
                    <td><span>{{item.firstName}}</span><span> </span><span>{{item.lastName}}</td>
                    <td><span>{{item.role}}</span></td>
                    <td><span>{{item.organizationName}}</span></td>
                        <td hidden="{{!isOrgAdmin(role)}}">
                        <div align="center">
                        <template is="dom-if" restamp="true" if="{{isOrgAdmin(role)}}">
                          <template restamp="true" is="dom-if" if="{{item.active}}">
                            <paper-button align="center" class="green" participant={{item}} on-tap="setAjaxInactivate"><b>Active</b></paper-button>
                          </template>
                        </template>
                        </div>
                        <div align="center">
                        <template is="dom-if" restamp="true" if="{{isOrgAdmin(role)}}">
                          <template restamp="true" is="dom-if" if="{{!item.active}}">
                            <paper-button align="center" class="red" participant={{item}} on-tap="setAjaxActivate"><b>Inactive<b></paper-button>
                          </template>
                        </template>
                        </div>
                        </td>
                      <div align="center">
                        <td hidden="{{!isOrgAdmin(role)}}" style="font-size: 1em;">
                          <paper-button class="editButton" raised on-tap="editUserModal" user={{item}} modalName="editUser" id="{{item.index}}"><b>Edit</b></paper-button>
                        </td>
                      </div>
                </tr>
            </template>
                  <app-admin-add id="inputModal"></app-admin-add>
                  <app-admin-edit id="editModal"></app-admin-edit>
            </tbody>
        </iecompat-table>
        <shape-iron-ajax-helper
            id="ajaxActivateUsers"
            resource=""
            body=""
            method="PUT"
            handle-as="json"
            on-response="callBackActivate"
            debounce-duration="300">
        </shape-iron-ajax-helper>
        <shape-iron-ajax-helper
            id="ajaxInactivateUsers"
            resource=""
            body=""
            method="PUT"
            handle-as="json"
            on-response="callBackInactivate"
            debounce-duration="300">
        </shape-iron-ajax-helper>
        <shape-iron-ajax-helper
            id="findUsers"
            resource="/admin/user/findAll"
            handle-as="json"
            on-response="callBack"
            debounce-duration="300">
        </shape-iron-ajax-helper>
    </template>
</dom-module>
<script>
    (function() {
    Polymer({
            is: 'app-admin-panel-user',
            properties: {
              id: String,
              firstName: String,
              role: String,
              organizationName: String,
              sortVal: "defaultsort",
              sortPass: String,
              sortReverse: false,
              lastSortVal: "username",
              organizationId : {
                type: String
              },
              role : {
                type: String
              }
          },

            _filter: function(val) {
                return function(user) {
                    if (!val) return true;
                    if (!user) return false;
                    return (user.id && ~user.id.toLowerCase().indexOf(val.toLowerCase())) ||
                            (user.firstName && ~user.firstName.toLowerCase().indexOf(val.toLowerCase())) ||
                            (user.role && ~user.role.toLowerCase().indexOf(val.toLowerCase())) ||
                            (user.organizationName && ~user.organizationName.toLowerCase().indexOf(val.toLowerCase()));
               };
            },

            isOrgAdmin : function (role) {
              if (role == "ADMIN") {
                return true
              }
              if (role == "ORG_ADMIN") {
                return true
              }
              if (role == "REGISTERED") {
                return false
              }
              if (role == "DPH_USER") {
                  return false;
              }
            },

            setAjaxActivate: function(e) {
              this.$.ajaxActivateUsers.resource="/admin/activate/" + e.currentTarget.participant.id;
              this.$.ajaxActivateUsers.body = JSON.stringify ({"targetUserId": e.currentTarget.participant.id});
              this.$.ajaxActivateUsers.method="PUT";
              this.$.ajaxActivateUsers.callBack=this.callBackActivate
              this.$.ajaxActivateUsers.generateRequest();
              activeIndicator=e.currentTarget;
            },

            setAjaxInactivate: function(e) {
              this.$.ajaxInactivateUsers.resource="/admin/inactivate/" + e.currentTarget.participant.id;
              this.$.ajaxInactivateUsers.body = JSON.stringify ({"targetUserId": e.currentTarget.participant.id});
              this.$.ajaxInactivateUsers.method="PUT";
              this.$.ajaxInactivateUsers.callBack=this.callBackInactivate
              this.$.ajaxInactivateUsers.generateRequest();
              activeIndicator=e.currentTarget;
            },

            callBackActivate: function(request) {
                for(var i = 0; i<this.users.length; i++){
                  if (this.users[i].id == activeIndicator.participant.id){
                    stringPath= 'users.'+i+'.active';
                    this.set(stringPath, true);
                  };
                };
            },

            callBackInactivate: function(request) {
               for(var i = 0; i<this.users.length; i++){
                 if (this.users[i].id == activeIndicator.participant.id){
                   stringPath= 'users.'+i+'.active';
                   this.set(stringPath, false);
                 };
               };
             },

            selectFunction: function(e) {
              val = e.target.getAttribute('sortinggroup');  //this allows the function to retreive the 'sortingGroup' attribute from the clicked button.
              this.sortPass = val;

              if (val === this.lastSortVal) {    //sortJim is a toggle that makes sure that rows do not stay in reverse
                  this.sortReverse = true;
                  this.sortVal = val.toUpperCase();
                  this.lastSortVal = val.toUpperCase;
                  }
              else
                {
                  this.sortReverse = false;
                  this.sortVal = val;
                  this.lastSortVal = val;

                };



              },

            _sort: function(val) {
                  var clicked = this.sortPass;
                  if (this.sortReverse) {
                            return function(a, b) {
                            if (a[clicked].toLowerCase() === b[clicked].toLowerCase()) return 0;
                            return a[clicked].toLowerCase() < b[clicked].toLowerCase() ? 1 : -1;
                          }
                      }

                      else {
                            return function(a, b) {
                            if (a[clicked].toLowerCase() === b[clicked].toLowerCase()) return 0;
                            return a[clicked].toLowerCase() < b[clicked].toLowerCase() ? -1 : 1;
                      };
                    }
             },

            //  handleResponse: function() {
            //    //this.users = request.detail.response;
             //
            //  },
             setajax: function() {
               this.$.findUsers.callBack = this.callBack
               this.$.findUsers.generateRequest();
             },

            callBack: function(request) {
              var tableBody = [];
              for (var i = 0; i < request.detail.response.length; i++) {
                tableBody.push([
                  request.detail.response[i].id,
                  request.detail.response[i].firstName + ' ' + request.detail.response[i].lastName,
                  request.detail.response[i].role,
                  request.detail.response[i].organizationName,
                  request.detail.response[i].active
                ]);
              }
              //this.$.table
              //loop to add an inde value to each object in the this.Users.Array
              for (i = 0 ; i < this.users.length; i ++)
              {
                this.users[i].index = i;
              };
            },

            ready: function() {
            },

            editUserModal: function(e) {
              this.$.editModal.editUserButton(e.model.item);
            },

            addUser: function(e){
                this.$.inputModal.addButton(e.target.parentNode.getAttribute("modalName"));
                document.querySelector('app-admin-add').setajaxOrgs();
            },
            elementMatches: function(element, query) {
              var siblingMatches = element.parentElement.querySelectorAll(query)
              for (var match = 0; match < siblingMatches.length; match++) {
                if (siblingMatches[match] == element) return true;
              }
              return false;
            }
        });
})();
</script>
