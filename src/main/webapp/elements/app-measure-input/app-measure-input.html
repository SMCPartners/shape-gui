<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../elements.html">


<dom-module id="app-measure-input">
    <style>
        .pms {
            @apply(--pm-style)
        };
        .child {
            order: 0;
            flex: 0 1 auto;
            align-self: center;
        };
        .parent {
            display: flex;
            flex-direction: row;
            flex-wrap: wrap;
            justify-content: space-around;
            align-content: space-between;
            align-items: flex-start;
        };
        .parenttwo {
            display: flex;
            flex-direction: row;
            flex-wrap: wrap;
            justify-content: center;
            align-content: space-between;
            align-items: flex-start;
        };
        .fraction1 {
            display: inline-block;
            position: relative;
            vertical-align: middle;
            letter-spacing: 0.001em;
            text-align: center;
            font-size: 20px;
        };
        .fraction2 {
            display: inline-block;
            position: relative;
            vertical-align: middle;
            letter-spacing: 0.001em;
            text-align: center;
            font-size: 40px;
        };
        .fraction1 > span {
            display: block;
            padding: 0.1em;
        };
        .fraction1 span.fdn {
            border-top: thin solid black;
        };
        .fraction1 span.bar {
            display: none;
        };
        .fraction2 > span {
            display: block;
            padding: 0.1em;
        };
        .fraction2 span.fdn {
            border-top: thin solid black;
        };
        .fraction2 span.bar {
            display: none;
        };
        .header {
            font-size: 36px;
        };
        .description {
            font-size: 20px;
            text-align: center;
            margin-left: 2em;
            margin-right: 2em;
            margin-top: 1em;
            margin-bottom: 1em;
        };
        .modalHeader {
            align: center;
        };
        .modalSection {
            font-size: 20px;
        };
        .leader {
            border-color: black;
        };
        .double {
            flex: 2 2;
        };
        .single {
            flex: 1 1;
        };
        .modalBox {
            position: fixed;
            width: 70%;
            height: 70%;
            top: 0;
            right: 0;
            bottom: auto;
            left: 0;
            margin: 0px !important;
        };
        .fab {
            position: fixed;
            z-index: 10;
            bottom: 5%;
            right: 5%;
        };
        #measureChart {
            margin-top: 1em;
            height: 80%
        };
        paper-dialog-scrollable {
          height: auto;

        }
        paper-tooltip {

          padding-right: 10px;
          padding-bottom: 10px;
          float: left;

        }
    </style>
    <template>

      <shape-iron-ajax-helper
        id="findMeasureInput"
        resource=""
        handle-as="json"
        on-response="callBack"
        debounce-duration="300">
      </shape-iron-ajax-helper>

      <shape-iron-ajax-helper
        id="findMeasureByOrg"
        resource="/admin/find/measureById"
        handle-as="json"
        body=""
        method="POST"
        on-response="secondCallBack"
        debounce-duration="300">
      </shape-iron-ajax-helper>


      <div class="fab">
        <paper-fab icon="add" elevation="5" on-tap="addMeasure" id="addFab"></paper-fab>
        <paper-tooltip for="addFab" offset="3">Add New Measure</paper-tooltip>
      </div>
      <paper-dialog-scrollable>
      <template is="dom-if" if="{{isMeasureData}}">
          <template is="dom-repeat" items="{{measures}}" measure={{item}}>
                <paper-material class="pms">
                    <div class="parent">
                        <div value="{{item.nqfId}}" class="child header">NQF ID: <span>{{item.nqfId}}</span></div>
                        <div class="child header">{{item.name}}</div>
                        <!--div class="child header">RP Quarter: <span>{{item.reportPeriodQuarter}}</span></div-->
                        <div class="child header">RP Year: <span>{{item.reportPeriodYear}}</span></div>
                        <div class="child">
                            <paper-icon-button icon="info" on-tap="measureDetail" id="{{item.name}}" data="{{item}}"></paper-icon-button>
                        </div>
                    </div>
                    <div class="child description">{{item.description}}</div>
                    <div class="parent">
                        <div class="fraction1 child">
                            <span class="fup">Numerator</span>
                            <span class="bar">/</span>
                            <span class="fdn">Denominator</span>
                        </div>
                        <div class="child header">=</div>
                        <div class="fraction2 child">
                            <span class="fup">{{item.numeratorValue}}</span>
                            <span class="bar">/</span>
                            <span class="fdn">{{item.denominatorValue}}</span>
                        </div>
                        <div class="child">
                          <google-chart
                            id="measureChart"
                            type="pie"
                            data="{{item.chartData}}"
                            options="{{item.chartOptions}}">
                          </google-chart>
                        </div>
                        <div class="child">
                            <paper-button raised on-tap="editMeasure" measure={{item}} id="{{item.name}}">Edit</paper-button>
                        </div>
                    </div>
                    <div class="parent">
                        <paper-material elevation="0" class="child resultBox">
                            <div class="resultForward">Your Measure Results:</div>
                            <div class="results">{{computePercentage(item.numeratorValue, item.denominatorValue)}}
                            </div>
                        </paper-material>
                    </div>
                        <!-- this is where aggregate measure results used to be -->
                </paper-material>
            </template>
          </template>
        </paper-dialog-scrollable>

    </template>
</dom-module>
<script>
    (function () {
        Polymer({
            is: 'app-measure-input',
            properties: {
                currentMeasure: String,
                nMeasure: String,
                measureid: {
                  type: String
                },
                isMeasureData: {
                  type: Number
                }
            },
            ready: function() {

                /*this.measures = [
                    {
                      name: 'Controlling High Blood Pressure',
                      NQF: 'NQF 0018',
                      //numerator: this.measureInput[0].numeratorValue,
                      //denominator: this.measureInput.denominatorValue,
                      aggregateNumerator: 18893,
                      aggregateDenominator: 23184,
                      chart: this.chartDefault,
                      // chartOptions: {
                      //   "title": "Controlling High Blood Pressure",
                      //   "pieHole": ".6",
                      //   "pieSliceText": "none"
                      // },
                      description: 'Percentage of patients 18-85 years of age who had a diagnosis of hypertension and whose blood pressure was adequately controlled (<140/90mmHg) during the measurement period.'
                    },

                      {
                        name: 'Diabetes: HbA1c Poor Control',
                        NQF: 'NQF 0059',
                        numerator: 2153,
                        denominator: 3597,
                        aggregateNumerator: 12948,
                        aggregateDenominator: 15034,
                        chart: this.chartDefault,
                        // chartOptions: {
                        //   "title": this.name,
                        //   "pieHole": ".6",
                        //   "pieSliceText": "none"
                        // },
                          description: 'Percentage of patients 18-75 years of age with diabetes who had hemoglobin A1c > 9.0% during the measurement period.'
                        }
                ];*/

            },
            attached: function() {

            },

            addMeasure: function (e) {
                // var nMeasure = e.currentTarget.id;
                // console.log(nMeasure);
                // appDemographicAdd.nameOfMeasure=nMeasure;
                document.querySelector('app-demographic-add').setGetUserDataAjax();
                testVar.open();
            },
            editMeasure: function (e) {
                var nMeasure=e.currentTarget.id;
                console.log(e.currentTarget);
                appDemographicInput.measureName=nMeasure;
                targetMeasure=e.currentTarget;
                this.inputMeasureID=e.currentTarget.measure.measureId;
                this.dbid=e.currentTarget.measure.id;
                this.reportPeriodQuarter=e.currentTarget.measure.reportPeriodQuarter;
                this.reportPeriodYear=e.currentTarget.measure.reportPeriodYear;
                document.querySelector('app-demographic-input').ajaxFindUsers();
                document.querySelector('app-demographic-input').loadMeasureStratification();
                demIn.open();
            },
            computePercentage: function (numerator, denominator) {
                var ratio = 100 * numerator / denominator;
                var percent = Math.round(ratio * 10)/10
                return percent + '%';
            },
            measureDetail: function (e) {
                var nInfo = e.currentTarget.id;
                console.log(e.currentTarget.data);
                appInformationModal.measNQF = e.currentTarget.data.name;
                appInformationModal.measDesc = e.currentTarget.data.description;
                appInformationModal.numDesc = e.currentTarget.data.numeratorDescription;
                appInformationModal.denomDesc = e.currentTarget.data.denominatorDescription;
                appInformationModal.exclDesc = e.currentTarget.data.exclusionsDescription;
                appInformationModal.NQFnumber = e.currentTarget.data.nqfId;
                // console.log(nDescription);
                // measureEdit=e.currentTarget;
                // appInformationModal.nameOfMeasure=nInfo;
                // appInformationModal.detailedDescription=nDescription;
                infoMod.open();
            },
            //To be added to object to style graphs:
            //"slices": ["0": {'color': #32cd32}, "1": {'color': 'transparent'}],

            callBack: function(request) {
              //targetMeasure
              //this.modalreportPeriodYear=request.detail.response.
              var response = request.detail.response;
              console.log(response);

              // get additional measure data
              if(response.length){
                this.isMeasureData=1;
                this.$.findMeasureByOrg.body = JSON.stringify(response);
                this.$.findMeasureByOrg.generateRequest();

                // display measure data we currently have
                this.set('measures', response);
                for (var measure in response) {
                  var currentMeasure = response[measure];
                  var chartData = [
                    ['Month', 'Days'],
                    ['Well Controlled', currentMeasure.numeratorValue],
                    ['Poorly Controlled', currentMeasure.denominatorValue - currentMeasure.numeratorValue]
                  ];


                  var chartOptions = {
                    "pieHole": ".6",
                    "pieSliceText": "none"
                  };
                  this.set('measures.'+measure+'.chartData', chartData);
                  this.set('measures.'+measure+'.chartOptions', chartOptions);
                }
                var yearArray = [];
                for (var measure in response) {
                  if (yearArray.indexOf(response[measure].reportPeriodYear) === -1){
                  yearArray.push(response[measure].reportPeriodYear);
                  }

                }
                console.log(yearArray);
                document.querySelector('app-history').set('years', yearArray);
              } else {
                this.isMeasureData=0;
              }
            },

            secondCallBack: function(request) {
              var response = request.detail.response;

              // for each measure
              for (var measure in this.measures) {
                var currentMeasure = this.measures[measure];

                // find appropriate object of additional data
                var done = false;
                for (var object = 0; object < response.length && !done; object++) {
                  var currentObject = response[object];
                  if (currentObject.id == currentMeasure.measureId) {
                    done = true;

                    // and add that data to it
                    for (var property in currentObject) {
                      var polymerResource = 'measures.' + measure + '.' + property;
                      this.set(polymerResource, currentObject[property]);
                    }

                  }
                }
              }
              // this.setAppHistoryGraph();

            },

            setAjaxMeasure: function() {
              if(app.$.mainPage.$.dashboard.isOrgSelected){
                this.$.findMeasureInput.resource = '/common/organization_measure/findAllByOrg/' + document.getElementById('findUserOrganizations').value;
                this.$.findMeasureInput.callBack = this.callBack;
                this.$.findMeasureInput.generateRequest();
              }
            },

            setAppHistoryGraph: function() {

              var orgMeasures = [];
              for (var measure in this.measures) {
                var currentMeasure = this.measures[measure];
                orgMeasures.push(
                  {
                    measureName: currentMeasure.name,
                    measureNQF: currentMeasure.nqfId,
                    measureDesc: currentMeasure.description,
                    reportYear: currentMeasure.reportPeriodYear,
                    reportQuart: currentMeasure.reportPeriodQuarter,

                    testraceData:
                      [
                        ["African American", (currentMeasure.raceAfricanAmericanNum / currentMeasure.raceAfricanAmericanDen)],
                        ["Native American", (currentMeasure.raceAmericanIndianNum / currentMeasure.raceAmericanIndianDen)],
                        ["Asian", (currentMeasure.raceAsianNum / currentMeasure.raceAsianDen)],
                        ["Native Hawaiian", (currentMeasure.raceNativeHawaiianNum / currentMeasure.raceNativeHawaiianDen)],
                        ["White", (currentMeasure.raceWhiteNum / currentMeasure.raceWhiteDen)],
                        ["Other", (currentMeasure.raceOtherNum / currentMeasure.raceOtherDen)]
                      ]
                    //
                    // ageData:
                    // [
                    //   ["test", "Numerator", "Denominator"],
                    //   ["Under 17", currentMeasure.ageUnder17Num, currentMeasure.ageUnder17Den],
                    //   ["18-44", currentMeasure.age1844Num, currentMeasure.age1844Den],
                    //   ["45-64", currentMeasure.age4564Num, currentMeasure.age4564Den],
                    //   ["65+", currentMeasure.ageOver65Num, currentMeasure.ageOver65Den]
                    // ],
                    // genderData:
                    // [
                    //   ["test", "Numerator", "Denominator"],
                    //   ["Female", currentMeasure.genderFemaleNum, currentMeasure.genderFemaleDen],
                    //   ["Male", currentMeasure.genderMaleNum, currentMeasure.genderMaleDen],
                    //   ["Other", currentMeasure.genderOtherNum, currentMeasure.genderOtherDen]
                    // ],
                    // ethniData:
                    // [
                    //   ["test", "Numerator", "Denominator"],
                    //   ["Hispanic", currentMeasure.ethnicityHispanicLatinoNum, currentMeasure.ethnicityHispanicLatinoDen],
                    //   ["Not Hispanic", currentMeasure.ethnicityNotHispanicLatinoNum, currentMeasure.ethnicityNotHispanicLatinoDen]
                    // ]
                  });
                };
                  //document.querySelector('app-history-demographics').set('orgMeasCharts', orgMeasures);
                  //console.log(orgMeasures);
            }
        });
    })();
</script>
