<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../elements.html">

<dom-module id="app-admin-panel-provider">
    <style>
        .pms {
        @apply(--pm-style)
        };

        th {
        text-align: center;
        background-color: #0066FF;
        color: white;
        border-right: 1px solid #808080;
        border-bottom: 1px solid #808080;
        font-weight: bold;
        };

        th, td {
          padding: 10px 15px;
          -webkit-user-select: none;   /*these make it so that text is not selectable*/
          -khtml-user-select: none;
          -moz-user-select: none;
          user-select: none;
          font-family: Roboto;
        };

        thead {
        background: #395870;
        color: #fff;
        };

        td {
        border-bottom: 1px solid #cecfd5;
        border-right: 1px solid #cecfd5;
        border-left: 1px solid #cecfd5;
        };

        td: first-child {
        border-left: 1px solid #cecfd5;
        };

        tr: nth-child(even) {
        background-color: #395870;
        };



        table {
        border-collapse: separate;
        border-spacing: 0;
        };

        .columnRight {
        flex: 0 0;
        };

        .alignright {
        float: right;
        };

        .editButton {
        justify-content: center;
        };

        .flex-item {
        order: 0;
        flex: 1 1 auto;
        align-self: auto;
        }

        .green, .red {
          color: white;
          align-self: center;
          width: 85px;
          margin: 2%;
        }

        .green {
          background-color: green;
        };

        .red {
          background-color: red;
        };
    </style>
    </shape-iron-ajax-helper>
    <template>
      <shape-iron-ajax-helper
          id="findProviders"
          resource="/common/provider/findAll"
          handle-as="json"
          on-response="callBack"
          debounce-duration="300">
      </shape-iron-ajax-helper>
      <shape-iron-ajax-helper
          id="ajaxActivateProvider"
          resource=""
          body=""
          method=""
          handle-as="json"
          on-response="callBackActivate"
          debounce-duration="300">
      </shape-iron-ajax-helper>
      <shape-iron-ajax-helper
          id="ajaxInactivateProvider"
          resource=""
          body=""
          method=""
          handle-as="json"
          on-response="callBackInactivate"
          debounce-duration="300">
        </shape-iron-ajax-helper>
        <shape-iron-ajax-helper
            id="getOrgNames"
            resource="/admin/organization/findAll"
            on-response="getOrgNamesCallBack"
            handle-as="json"
            debounce-duration="300">
          </shape-iron-ajax-helper>

        <div style="padding: 0 0.4em; display: flex;" class='flex-container'>
            <div class='flex-item'>
                <input class="search" type="text" value="{{filterVal::input}}" data-table="order-table" placeholder="Search" style="height: 2em; margin: 0.5em 0.4em;">
            </div>

            <div class="flex-item">
                <paper-button raised on-tap="addProvider" modalName="addProvider" style="float:right; padding-top: 0.1em;">Add Provider</paper-button>
            </div>
        </div>

        <table class="order-table table-hover" style="width: 100%; padding: 0 0.4em;">
            <!-- <colgroup>
                <col span="4" style="width:23.5%">
                <col span="1" style="width:6%">
            </colgroup> -->
            <thead>
                <!-- sorting not working on npi -->
                <th sortingGroup="name" on-tap="selectFunction">Name</th>
                <th sortingGroup="npi" on-tap="selectFunction">NPI</th>
                <th sortingGroup="organization" on-tap="selectFunction">Organization</th>
                <th sortingGroup="active" on-tap="selectFunction">Status</th>
                <th></th>
            </thead>
            <tbody>
            <template is="dom-repeat" items="{{providers}}" filter="{{_filter(filterVal)}}" sort="{{_sort(sortVal)}}">
                <tr data-id$="{{item.id}}">
                    <td><span>{{item.name}}</span></td>
                    <td><span>{{item.npi}}</span></td>
                    <td><span>{{item.organization}}</span></td>
                    <td>

                      <template restamp="true" is="dom-if" if="{{item.active}}">
                        <paper-button align="center" class="green activeButton" providers={{item}} on-tap="setAjaxInactivate"><b>Active</b></paper-button>
                      </template>
                      <template restamp="true" is="dom-if" if="{{!item.active}}">
                        <paper-button align="center" class="red activeButton" providers={{item}} on-tap="setAjaxActivate"><b>Inactive<b></paper-button>
                      </template>

                    </td>
                    <td style="font-size: 12px">
                        <div class="editButton">
                            <paper-button raised on-tap="editProvider" modalName="editProvider">Edit</paper-button>
                        </div>
                    </td>
                </tr>
                </template>
                <app-admin-add id="inputModal"></app-admin-add>
                <app-admin-edit id="editModal"></app-admin-edit>
            </tbody>
        </table>
    </template>
</dom-module>
<script>
    (function() {
    Polymer({
            is: 'app-admin-panel-provider',
            properties: {
            firstName: String,
            lastName: String,
            npiNum: String,
            organization: String,
            sortVal: "defaultsort",
            sortPass: String,
            sortReverse: false,
            lastSortVal: "firstName"
            },

            _filter: function(val) {
                return function(provider) {
                    if (!val) return true;
                    if (!provider) return false;
                    return (provider.name && ~provider.name.toLowerCase().indexOf(val.toLowerCase())) ||
                            (provider.npi && ~provider.npi.toString().indexOf(val.toLowerCase())) ||
                            (provider.organization && ~provider.organization.toLowerCase().indexOf(val.toLowerCase()));
               };
            },

            selectFunction: function(e) {
              val = e.target.getAttribute('sortingGroup');  //this allows the function to retreive the 'sortingGroup' attribute from the clicked button.
              this.sortPass = val;
              console.log("target click: " + val);
              console.log("lastSortVal is " + this.lastSortVal);

              if (val === this.lastSortVal) {    //sortJim is a toggle that makes sure that rows do not stay in reverse
                  this.sortReverse = true;
                  this.sortVal = val.toUpperCase();
                  this.lastSortVal = val.toUpperCase();
                  }
              else
                {
                  this.sortReverse = false;
                  this.sortVal = val;
                  this.lastSortVal = val;

                };



              },

              setAjaxActivate: function(e) {
                this.$.ajaxActivateProvider.resource="/admin/provider/activate";
                this.$.ajaxActivateProvider.body = JSON.stringify ({"entId": e.currentTarget.providers.id});
                this.$.ajaxActivateProvider.method="POST";
                this.$.ajaxActivateProvider.callBack=this.callBackActivate;
                this.$.ajaxActivateProvider.generateRequest();
                activeIndicator=e.currentTarget;
              },

              setAjaxInactivate: function(e) {
                this.$.ajaxInactivateProvider.resource="/admin/provider/inactivate";
                this.$.ajaxInactivateProvider.body = JSON.stringify ({"entId": e.currentTarget.providers.id});
                this.$.ajaxInactivateProvider.method="POST";
                this.$.ajaxInactivateProvider.callBack=this.callBackInactivate;
                this.$.ajaxInactivateProvider.generateRequest();
                activeIndicator=e.currentTarget;
              },

              callBackActivate: function(request) {
                  for(var i = 0; i<this.providers.length; i++){
                    if (this.providers[i].id == activeIndicator.providers.id){
                      var stringPath= 'providers.'+i+'.active';
                      this.set(stringPath, true);
                    };
                  };
              },

              callBackInactivate: function(request) {
                 for(var i = 0; i<this.providers.length; i++){
                   if (this.providers[i].id == activeIndicator.providers.id){
                     var stringPath= 'providers.'+i+'.active';
                     this.set(stringPath, false);
                   };
                 };
               },

            _sort: function(val) {
                  var clicked = this.sortPass;
                  console.log("sortReverse is " + this.sortReverse)
                  if (this.sortReverse) {
                            return function(a, b) {
                            a = a[clicked];
                            b = b[clicked];
                            if (typeof a == 'string') {
                              a = a.toLowerCase();
                              b = b.toLowerCase();
                            }
                            if (a === b) return 0;
                            return a < b ? 1 : -1;
                          }
                      }

                      else {
                            return function(a, b) {
                            a = a[clicked];
                            b = b[clicked];
                            if (typeof a == 'string') {
                              a = a.toLowerCase();
                              b = b.toLowerCase();
                            }
                            if (a === b) return 0;
                            return a < b ? -1 : 1;
                      };
                    }
             },
            setajax: function() {
              this.$.findProviders.callBack = this.callBack
              this.$.findProviders.generateRequest();
             },

            callBack: function(request) {
              this.set('providers', request.detail.response);
              this.$.getOrgNames.generateRequest();
            },

            getOrgNamesCallBack: function(request) {
              var response = request.detail.response;
              for (var provider in this.providers) {
                var currentProvider = this.providers[provider];
                var done = false;
                for (var org = 0; org < response.length && !done; org ++) {
                  var currentOrg = response[org];
                  if (currentProvider.organizationId == currentOrg.id) {
                    done = true;
                    this.set('providers.'+provider+'.organization', currentOrg.name);
                  }
                }
              }
            },

            editProvider: function(e) {
              var providerId = this.findAncestor(e.target, 'tr').dataset.id;
              for (var provider in this.providers) {
                if (this.providers[provider].id == providerId) {
                  var providerData = this.providers[provider];
                }
              }
              this.$.editModal.editButton(e.target.parentNode.getAttribute("modalName"), providerData);
            },

            addProvider: function(e){
                this.$.inputModal.addButton(e.target.parentNode.getAttribute("modalName"));
            },
            findAncestor: function(element, query) {
              do {
                element = element.parentElement;
              } while (element && !this.elementMatches(element, query))
              return element;
            },
            elementMatches: function(element, query) {
              var siblingMatches = element.parentElement.querySelectorAll(query)
              for (var match = 0; match < siblingMatches.length; match++) {
                if (siblingMatches[match] == element) return true;
              }
              return false;
            }
        });
})();
</script>
