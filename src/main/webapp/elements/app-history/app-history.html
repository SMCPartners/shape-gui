<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../elements.html">


<dom-module id="app-history">
    <style>
        .pms {
            @apply(--pm-style)
        };
        .child {
            order: 0;
            flex: 0 1 auto;
            align-self: center;
            z-index: 9;
        };
        .parent {
            display: flex;
            flex-direction: row;
            flex-wrap: wrap;
            justify-content: space-around;
            align-content: space-between;
            align-items: flex-start;
            z-index: 9;
        };
        .parenttwo {
            display: flex;
            flex-direction: row;
            flex-wrap: wrap;
            justify-content: center;
            align-content: space-between;
            align-items: flex-start;
            z-index: 9;
        };
        .header {
            font-size: 36px;
        };
        .modalHeader {
        align: center;
        };
        .modalSection {
        font-size: 20px;
        };
        .leader {
        border-color: black;
        };
        .double {
        flex: 2 2;
        };
        .single {
        flex: 1 1;
        };

        select[selected] {
        border: none;
        }
        select {
        height: 2.5em;
        font-size: 1em;
        background: transparent;
        border: none;
        }
        select[focused] {
        border: none;
        }

    </style>
    <template>
        <div class="pms">
            <div class="parent">
                <div class="child parent">
                    <label class="child" style="font: inherit; margin-left:0.5em;"><b>Measure:</b> </label>
                    <div class="child" style="box-shadow: 1px 1px 1px 1px lightgray; margin: 0 1em;">
                        <select id="selectMeasure" name="measure" style="font: inherit" on-change="setAjaxYears">
                          <option value = "label">Select Measure</option>
                            <template is="dom-repeat" restamp="true" selectedMeasures={{item}} items="{{measures}}">
                              <template is="dom-if" if="{{item.selected}}">
                                <option style="font: inherit" value={{item.id}}>
                                    NQF <span>{{item.nqfId}}</span> <span>{{item.name}}</span>
                                </option>
                              </template>
                            </template>
                        </select>
                    </div>

                    <!-- <select id=findUserRole style="font: inherit; margin-left:0.5em;">
                        <option>Select Role</option>
                        <option value="ADMIN">Admin</option>
                        <option value="ORG_ADMIN">Organization Admin</option>
                        <option value="REGISTERED">Registered</option>
                    </select> -->

                    <!--
                    <select>
                        <option>NQF 0018 Controlling High Blood Pressure</option>
                        <option>NQF 0059 Diabetes: HbA1c Poor Control</option>
                    </select>
                    -->
                </div>
                <div class="child parent">
                    <label class="child" style="font: inherit; margin-left:0.5em;"> <b>Year:</b> </label>
                    <div class="child" style="box-shadow: 1px 1px 1px 1px lightgray; margin: 0 1em;">
                        <select id="selectYear" style="font: inherit" on-change="loadMeasureData" disabled>
                            <template is="dom-repeat" items="{{years}}">
                                <option style="font: inherit" value="{{item}}">
                                    <span>{{item}}</span>
                                </option>
                            </template>
                        </select>
                    </div>
                    <!--
                    <select>
                        <option>2015</option>
                        <option>2014</option>
                        <option>2013</option>
                        <option>2012</option>
                        <option>2011</option>
                    </select>
                    -->
                </div>
                <div class="child parent">
                    <label class="child" style="font: inherit; margin-left:0.5em;"><b>Analytics:</b></label>
                    <div class="child" style="box-shadow: 1px 1px 1px 1px lightgray; margin: 0 1em;">
                        <select value="{{selectedView::change}}" style="font: inherit;" on-change="loadMeasureData">
                            <option value ="label">Choose view..</option>
                            <option value="0">List View</option>
                            <option value="1">Aggregate Comparison</option>
                            <option value="2">Measure Demographics</option>
                        </select>
                    </div>
                </div>
            </div>
            <div>
                <!--
                <paper-tabs selected="{{selected}}">
                    <paper-tab>List</paper-tab>
                    <paper-tab>Measure Trend</paper-tab>
                    <paper-tab>Measure Demographics</paper-tab>
                </paper-tabs>
                -->
                <div hidden$="{{nothingshowing}}"><!-- FIX ME -->
                <div hidden$="{{!isDataForMeasure}}">
                  <iron-pages selected="{{selectedView}}">
                      <app-history-list-view id = "histolist"></app-history-list-view>
                      <app-history-aggregate id="histoaggregate"></app-history-aggregate>
                      <app-history-demographics id="histographic"></app-history-demographics>
                  </iron-pages>
                </div>
                <div hidden$="{{isDataForMeasure}}">
                <h2 style="text-align:center;margin-top:2.5%">There is no data for this measure.</h2>
                </div>
                </div>
              </div>
            </div>
        </div>
        <shape-iron-ajax-helper
          id="findMeasures"
          resource=""
          method="GET"
          handle-as="json"
          on-response="callBackMeasures"
          debounce-duration="300">
        </shape-iron-ajax-helper>
        <shape-iron-ajax-helper
          id="findYears"
          resource="/common/get/measure_years/1/1"
          method="GET"
          handle-as="json"
          on-response="callBackYears"
          debounce-duration="300">
        </shape-iron-ajax-helper>
    </template>
</dom-module>
<script>
    (function () {
        Polymer({
            is: 'app-history',
            properties: {
              owner : {
                    type: String,
                    value: 'Daniel',
                    notify: true
                },
              selectMeasure : {
                Array
              },
              isDataForMeasure: {
                value: true
              }
                /*stratify: {
                    gender1: "Male",
                    gender2: "Female",
                    race1: "African American/Black",
                    race2: "American Indian or Alaska Native",
                    race3: "Asian",
                    race4: "Native Hawaiian or Pacific Islander",
                    race5: "White",
                    race6: "Other",
                    ethnicity1: "Hispanic/Latino",
                    ethnicity2: "Not Hispanic/Latino",
                    age1: "18-44 Years",
                    age2: "45-64 Years",
                    age3: "65-85 Years"
                };*/

            },
            setMeasureDefault: function(){
                this.nothingshowing = true;
                this.$.selectMeasure.value = "label"
            },

            setajaxMeasures: function () {
              this.$.findMeasures.resource = "/common/measure/findAll";
              this.$.findMeasures.callBack=this.callBackMeasures;
              this.$.findMeasures.generateRequest();
            },
            setAjaxYears: function(){ // make call to get years, for the measure selected and teh organization selected
              this.$.selectMeasure.value !=="label" ? this.isMeasureSelected = true : this.isMeasureSelected = false;
              if (this.isMeasureSelected){
                this.$.selectYear.disabled=true;
                orgId = document.querySelector('app-dashboard').organizationId
                measureId = this.$.selectMeasure.value;
                this.$.findYears.resource = "/common/get/measure_years/"+orgId+"/"+measureId;// set call for given organzaiton and for given measure
                this.$.findYears.callBack=this.callBackYears;
                this.$.findYears.generateRequest()
              }

            },
            callBackYears: function(evt){
              console.log(evt.detail.response);
              this.$.selectYear.disabled = false;
              this.set('years', evt.detail.response);// get all years for given measure for organization
              (!this.years.length) ? this.isDataForMeasure = false : this.isDataForMeasure = true; // if there are no years with data, there is no data for that measure
              this.loadMeasureData();
            },

            callBackMeasures: function(request) {
              this.measures=request.detail.response;
            },

            ready: function() {
                this.owner="it is here";
                this.years = [];


            },
            loadMeasureData: function() {
              // this.setAjaxYears()
              this.$.selectYear.value !="" ? this.isYearSelected = true : this.isYearSelected = false;
              if (app.$.mainPage.$.dashboard.isOrgSelected && this.years.length && this.isMeasureSelected ){
                  for(i = 0; i < this.years.length; i++) {    //This
                    if (this.$.selectYear.value = this.years[i]) {
                      year = this.$.selectYear.value;
                      break;
                    } else {
                      year = this.years[0];
                    }
                  }

                //year = (this.$.selectYear.value) ? this.$.selectYear.value : this.years[0];
                measure = this.$.selectMeasure.value;
                orgId = app.$.mainPage.$.dashboard.$.findUserOrganizations.value;
                this.$.histographic.setAjax(orgId, measure, year);
                this.$.histoaggregate.setAjax(orgId, measure, year);
                this.$.histolist.setajax(orgId, measure, year);
                this.nothingshowing = false ; // this was a work around for the years array not updating for the drop down. see related fix me above

              }
            },

        });
    })();

</script>
